<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¤ãƒ³ã‚¿ãƒãƒƒãƒˆæ¥ç¶š</title>
<link rel="stylesheet" href="common-layout2.css">
<style>
  .video-container {
   display: flex;
   flex-direction: row;
   justify-content: center; 
   align-items: center;
   gap: 20px;
   margin-top: 50px;
  }
  .video-container iframe {
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  iframe {
   width: 360px;
   height: 215px;
   border: none;
  }
  .status {
   margin-top: 10px;
   font-size: 15px;
  }
  audio {
   display: none;
  }
</style>
</head>

<body>
<h1>
  <div class="header-left-group">
    <a href="../index.html" class="header-home-btn">ãƒ›ãƒ¼ãƒ </a>
    <a href="summary.html" class="header-home-btn" style="margin-left:5px;">çµæœã¾ã¨ã‚</a>
  </div>
  <span class="title-link">ã‚¤ãƒ³ã‚¿ãƒãƒƒãƒˆãƒ»ãƒ†ã‚¹ãƒˆ</span>
</h1>

<div class="video-container">
  <div id="player1"></div>
</div>

<div class="status">
  <p>â€ å‹•ç”»ãŒ20ç§’ä»¥ä¸Šã€å†ç”Ÿã§ãã‚Œã°OK</p>
  <p>â å†ç”Ÿä¸­ã«ã€è¼åº¦ã¨éŸ³é‡ãƒ†ã‚¹ãƒˆã‚‚ã—ã¦ãƒ</p>
</div>

<a href="https://youtu.be/1u6fRer9oVw" target="_blank">
  YoutubeãŒãŒå‡ºã¦æ¥ãªã„å ´åˆã¯ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯
</a>

<div class="nav-buttons">
  <button class="nav-button" onclick="playAndNavigate('sound-previous', 'whitespot-test.html')">â¬… å‰ã®ãƒ†ã‚¹ãƒˆ</button>
  <button class="nav-button" onclick="playAndNavigate('sound-home', '../index.html')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
  <button class="nav-button" onclick="playAndNavigate('sound-next', 'touchscreen-test.html')">æ¬¡ã®ãƒ†ã‚¹ãƒˆ â¡</button>
</div>

<audio id="sound-previous" src="../media/audio/previous-button-sound.mp3" preload="auto"></audio>
<audio id="sound-home" src="../media/audio/home-button-sound.mp3" preload="auto"></audio>
<audio id="sound-next" src="../media/audio/next-button-sound.mp3" preload="auto"></audio>

<div class="nav-buttons">
  <div class="nav-left">
    <button onclick="playAndNavigate('sound-previous', 'whitespot-test.html')">â¬… å‰ã®ãƒ†ã‚¹ãƒˆ</button>
  </div>
  <div class="nav-center">
    <button class="button button3">ä¸åˆæ ¼</button>
    <button class="button button2">åˆ¤å®šä¿ç•™</button>
    <button class="button button1">åˆæ ¼</button>
  </div>
  <div class="nav-right">
    <button onclick="playAndNavigate('sound-next', 'touchscreen-test.html')">æ¬¡ã®ãƒ†ã‚¹ãƒˆ â¡</button>
  </div>
</div>

<script>
  // --- 1. ë³€ìˆ˜ ì„ ì–¸ (Variable Declarations) ---
  let player1;
  let retryCount = 0;
  const maxRetries = 3;
  const retryDelay = 2000;
  let isPlayerInitialized = false;
  let isAPILoaded = false;

  // --- 2. í•¨ìˆ˜ ì •ì˜ (Function Definitions) ---

  /**
   * ì‚¬ìš´ë“œ ì¬ìƒ í›„ ì§€ì •ëœ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
   * @param {string} soundId - ì¬ìƒí•  audio ìš”ì†Œì˜ ID
   * @param {string} nextPage - ì´ë™í•  í˜ì´ì§€ URL
   */
  function playAndNavigate(soundId, nextPage) {
    const audio = document.getElementById(soundId);
    if (!audio) {
      location.href = nextPage;
      return;
    }
    audio.currentTime = 0;
    audio.play().then(() => {
      setTimeout(() => { location.href = nextPage; }, 400);
    }).catch(() => {
      location.href = nextPage;
    });
  }

  /**
   * í•˜ë‹¨ 'í•©ê²©/ë¶ˆí•©ê²©' ë²„íŠ¼ì˜ ìƒíƒœë¥¼ ì„¤ì •í•˜ê³  localStorageì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
   */
  function setBottomToggleButtons() {
    const testKey = 'ã‚¤ãƒ³ã‚¿ãƒãƒƒãƒˆæ¥ç¶š';
    const storageKey = 'testResult_' + testKey;
    const btns = document.querySelectorAll('.nav-center .button');

    const saved = localStorage.getItem(storageKey);
    btns.forEach(btn => {
      if (btn.textContent === saved) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });

    btns.forEach(btn => {
      btn.addEventListener('click', function() {
        if (this.classList.contains('selected')) {
          this.classList.remove('selected');
          localStorage.removeItem(storageKey);
          return;
        }
        btns.forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        localStorage.setItem(storageKey, this.textContent);
      });
    });
  }

  /**
   * YouTube API ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
   */
  function loadYouTubeAPI() {
    // ì´ë¯¸ ë¡œë“œ ì¤‘ì´ê±°ë‚˜ ë¡œë“œëœ ê²½ìš° ì¤‘ë³µ ë°©ì§€
    if (isAPILoaded || document.querySelector('script[src*="youtube.com/iframe_api"]')) {
      return;
    }

    isAPILoaded = true;
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    tag.async = true;
    
    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
    tag.onerror = function() {
      console.error('Failed to load YouTube API');
      isAPILoaded = false;
      retryLoadPlayer();
    };
    
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  }

  /**
   * YouTube í”Œë ˆì´ì–´ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
   */
  function createPlayer() {
    if (isPlayerInitialized) return;

    const playerContainer = document.getElementById('player1');
    if (!playerContainer) {
      console.error('Player container not found');
      return;
    }

    // ê¸°ì¡´ í”Œë ˆì´ì–´ ì •ë¦¬
    if (player1) {
      try {
        if (typeof player1.destroy === 'function') {
          player1.destroy();
        }
      } catch (e) {
        console.log('Error destroying existing player:', e);
      }
      player1 = null;
    }

    // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    playerContainer.innerHTML = '';

    try {
      player1 = new YT.Player('player1', {
        height: '215',
        width: '360',
        videoId: '1u6fRer9oVw',
        playerVars: {
          autoplay: 0,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          showinfo: 0
        },
        events: {
          'onReady': onPlayerReady,
          'onError': onPlayerError
        }
      });

      // í”Œë ˆì´ì–´ ìƒì„± í™•ì¸ íƒ€ì´ë¨¸
      setTimeout(() => {
        if (!player1 || typeof player1.getPlayerState !== 'function') {
          console.log('Player not properly initialized, retrying...');
          isPlayerInitialized = false;
          retryLoadPlayer();
        }
      }, 3000);

    } catch (error) {
      console.error('Error creating YouTube player:', error);
      retryLoadPlayer();
    }
  }

  /**
   * í”Œë ˆì´ì–´ ë¡œë“œ ì¬ì‹œë„ í•¨ìˆ˜
   */
  function retryLoadPlayer() {
    retryCount++;
    if (retryCount <= maxRetries) {
      console.log(`Retrying player load (attempt ${retryCount}/${maxRetries})`);
      isPlayerInitialized = false;

      const playerDiv = document.getElementById('player1');
      if (playerDiv) playerDiv.innerHTML = '';
      
      setTimeout(() => {
        // APIê°€ ë¡œë“œë˜ì–´ ìˆë‹¤ë©´ ë°”ë¡œ í”Œë ˆì´ì–´ ìƒì„±, ì•„ë‹ˆë©´ API ë¡œë“œë¶€í„°
        if (typeof YT !== 'undefined' && YT.Player) {
          createPlayer();
        } else {
          initializeYouTubePlayer();
        }
      }, retryDelay);
    } else {
      console.error('Max retries reached. Player initialization failed.');
      const playerDiv = document.getElementById('player1');
      if (playerDiv) {
        playerDiv.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">YouTube í”Œë ˆì´ì–´ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ìœ„ì˜ ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.</p>';
      }
    }
  }

  /**
   * í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
   */
  function onPlayerReady(event) {
    console.log('YouTube player ready');
    isPlayerInitialized = true;
    retryCount = 0; // ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
  }

  /**
   * í”Œë ˆì´ì–´ ì—ëŸ¬ ë°œìƒ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
   */
  function onPlayerError(event) {
    console.error('YouTube player error:', event.data);
    isPlayerInitialized = false;
    retryLoadPlayer();
  }

  /**
   * YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
   */
  function initializeYouTubePlayer() {
    const playerContainer = document.getElementById('player1');
    if (!playerContainer) {
      console.error('Player container not found');
      return;
    }
    
    // APIê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° (ë’¤ë¡œê°€ê¸° ë“±)
    if (typeof YT !== 'undefined' && YT.Player) {
      createPlayer();
    } else { 
      // APIê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°
      // ì „ì—­ ì½œë°± í•¨ìˆ˜ ì¤‘ë³µ ë°©ì§€
      if (!window.onYouTubeIframeAPIReady) {
        window.onYouTubeIframeAPIReady = createPlayer;
      }
      loadYouTubeAPI();
    }
  }
  
  /**
   * í˜ì´ì§€ë¥¼ ë– ë‚˜ê¸° ì „ í”Œë ˆì´ì–´ë¥¼ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜
   */
  function cleanupPlayer() {
    if (player1 && typeof player1.destroy === 'function') {
      try {
        player1.destroy();
        player1 = null;
      } catch (e) {
        console.log('Error destroying player on unload:', e);
      }
    }
    isPlayerInitialized = false;
  }

  // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (Event Listener Registrations) ---
  
  /**
   * í˜ì´ì§€ì˜ ëª¨ë“  ì½˜í…ì¸ ê°€ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ì„ ì‹¤í–‰
   */
  document.addEventListener('DOMContentLoaded', () => {
    setBottomToggleButtons();
    initializeYouTubePlayer();
  });

  /**
   * ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬
   */
  window.addEventListener('beforeunload', cleanupPlayer);

  // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ì²˜ë¦¬ (íƒ­ ì „í™˜ ë“±)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ í”Œë ˆì´ì–´ ì¼ì‹œì •ì§€ (ì„ íƒì‚¬í•­)
      if (player1 && typeof player1.pauseVideo === 'function') {
        try {
          player1.pauseVideo();
        } catch (e) {
          console.log('Error pausing video:', e);
        }
      }
    }
  });

</script>

</body>
</html>